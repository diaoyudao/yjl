var current_uploader=null;function getCurrentUploader(e){if($("#"+e.id).parent().attr("id")=="big-file-list"){return big_file_uplad}else{return file_upload}}WebUploader.Uploader.register({"before-send-file":"beforeSendFile","before-send":"beforeSend","after-send-file":"afterSendFile"},{beforeSendFile:function(e){if(chunkSize>=e.size){return false}var a=new $.Deferred;var r=(new Date).getTime();uniqueFileName=md5(e.name+e.size);var t=getCurrentUploader(e);if(!t){return false}$.ajax({type:"POST",url:check_url,data:{type:"initFile",uniqueFileName:uniqueFileName},cache:false,async:false,timeout:1e3,dataType:"json"}).then(function(r,i,n){if(r.complete){a.reject();t.setProcessStatus(e,"上传完毕！");t.setSuccessResult(r);t.skipFile(e);t.uploader.trigger("uploadComplete",e)}else{a.resolve()}},function(e,r,t){a.resolve()});return $.when(a)},beforeSend:function(e){if(chunkSize>=e.file.size){return false}var a=new $.Deferred;$.ajax({type:"POST",url:check_url,data:{type:"checkBlock",uniqueFileName:uniqueFileName,chunk:e.chunk,size:e.end-e.start},cache:false,async:false,timeout:1e3,dataType:"json"}).then(function(e,r,t){if(e.is_exists){a.reject()}else{a.resolve()}},function(e,r,t){a.resolve()});return $.when(a)},afterSendFile:function(e){if(chunkSize>=e.size){return false}var a=Math.ceil(e.size/chunkSize);if(a>1){var r=getCurrentUploader(e);if(!r){return false}var t=new $.Deferred;$.ajax({type:"POST",url:check_url,data:{type:"mergeBlock",uniqueFileName:uniqueFileName,name:e.name,chunks:a,size:e.size},cache:false,async:false,dataType:"json"}).then(function(a,i,n){if(a.status&&"ok"==a.status){r.setSuccessResult(a);r.setProcessStatus(e,"文件已上传完毕！");t.resolve()}else{r.setFailedResult(a);t.reject();r.uploader.trigger("uploadError",e)}},function(e,a,i){r.uploader.trigger("uploadError");t.reject()});return $.when(t)}}});var check_url="/adminenglish/upload/largefile/check";var chunkSize=3*1024*1024;var upload_large_file={create:function(e,a,r,t,i,n,s){var l;var e=e||"#big-file-list";var a=a||"#big-file-picker";var s=s||"/adminenglish/upload/largefile/upload";var n=n||"/adminenglish/upload/largefile/check";var r=r||"#big-file-start";var u=null;var o=$(e);var c=$(r);var i=i||function(e){$("input[name=url]").val("")};var t=t||function(e){$("input[name=url]").val(e.url)};var l=new WebUploader.Uploader({chunked:true,chunkSize:chunkSize,chunkRetry:3,threads:1,duplicate:true,server:s,pick:{id:a,multiple:false},resize:false,prepareNextFile:true,formData:{uniqueFileName:u}});l.on("beforeFileQueued",function(e){u=md5(e.name+e.size);var a=false;$.ajax({type:"POST",url:n,data:{type:"percentage",uniqueFileName:u,name:e.name,size:e.size},cache:false,async:false,dataType:"json"}).then(function(r,i,n){if(r.percentage&&"100"==r.percentage){t(r);f(e,"文件已上传完毕！");a=true}else{f(e,"等待上传，请点击开始上传...")}},function(a,r,t){f(e,"等待上传，请点击开始上传...")});if(a){return false}});l.on("uploadProgress",function(e,a){var r=$("#"+e.id),t=r.find(".progress .progress-bar");if(!t.length){t=$('<div class="progress progress-striped active">'+'<div class="progress-bar" role="progressbar" style="width: 0%">'+"</div>"+"</div>").appendTo(r).find(".progress-bar")}r.find("p.state").text("上传中...");t.css("width",a*100+"%")});l.on("uploadSuccess",function(e,a){if(chunkSize>=e.size){if(a.status&&"ok"==a.status){t(a);d(e,"文件已上传完毕！")}else{i(a);d(e,"上传出错，请重新选择文件后再次上传！")}}});l.on("uploadError",function(e){$("#"+e.id).find("p.state").text("上传出错，请重新选择文件后再次上传!")});l.on("uploadComplete",function(e){if($("#"+e.id).find(".progress")){$("#"+e.id).find(".progress").fadeOut()}c.text("开始上传")});c.on("click",function(){var e=c.text();if(e==="暂停上传"){l.stop(true);c.text("开始上传")}else{c.text("暂停上传");l.upload()}});var f=function(a,r){o.empty();o.append('<div id="'+a.id+'" class="item">'+'<h4 class="info">'+a.name+"</h4>"+'<p class="state">'+r+"</p>"+"</div>");c.text("开始上传");if(e=="#big-file-list"){$("input[name=name]").val(a.name);$("input[name=size]").val(a.size)}};var d=function(e,a){$("#"+e.id).find("p.state").text(a)};return{uploader:l,setProcessStatus:d,setSuccessResult:t,setFailedResult:i}}};